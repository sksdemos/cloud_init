#cloud-config

users:
  - default
  - name: root
    lock-passwd: false
    hashed_passwd: {{image.value.vm_root_passwd | string | password_hash('sha512')}}

{% if image.value.vm_static_ip is defined %}
write_files:
- content: |
    # Cloudinit icfg-eth0 file (centos/redhat format)

    BOOTPROTO=STATIC
    DEVICE=eth0
    ONBOOT=yes
    TYPE=Ethernet
    USERCTL=no
    IPADDR={{ cloud_vms_info.utility.vm_static_ip | ipaddr('address') }}
    NETMASK={{ cloud_vms_info.utility.vm_netmask }}
    GATEWAY={{ cloud_vms_info.utility.vm_gateway }}
{% if image.value.vm_dns1 is defined %}
    DNS1={{ cloud_vms_info.utility.vm_dns1 }}
{% endif %}
    NM_CONTROLLED=no
  path: /etc/sysconfig/network-scripts/ifcfg-eth0

runcmd:
  - sed -i -e '/^PasswordAuthentication/s/^.*$/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart sshd

power_state:
  mode: reboot
  
{% else %}
runcmd:
  - sed -i -e '/^PasswordAuthentication/s/^.*$/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart sshd
{% endif %}



